<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒ«ãƒå‹•ç”»ãƒ“ãƒ¥ãƒ¼ã‚¢ multi video viewer</title>
    <style>
        :root {
            --bg-color: #1a1f2c;
            --bg-secondary-color: #2c344b;
            --text-color: #e0e0e0;
            --primary-color: #00aaff;
            --border-color: #444c66;
            --input-bg-color: #2c344b;
            --button-bg-color: #4a5472;
            --button-hover-bg-color: #626c91;
            --danger-color: #e74c3c;
            --sidebar-width: 280px;
        }
        .light-theme {
            --bg-color: #f0f2f5;
            --bg-secondary-color: #ffffff;
            --text-color: #333333;
            --primary-color: #007bff;
            --border-color: #d1d5db;
            --input-bg-color: #ffffff;
            --button-bg-color: #e4e6eb;
            --button-hover-bg-color: #d8dbdf;
            --danger-color: #dc3545;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            background-color: var(--bg-color);
            margin: 0;
            color: var(--text-color);
            font-family: 'Segoe UI', Meiryo, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            display: flex;
            height: 100vh;
            /* èƒŒæ™¯ç”»åƒç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
        }
        /* --- Layout --- */
        #left-sidebar, #right-sidebar, #footer-controls {
            transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s;
            z-index: 100;
        }
        #left-sidebar, #right-sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-secondary-color);
            padding: 15px;
            height: 100vh;
            overflow-y: auto;
            flex-shrink: 0;
            border-left: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
        }
        #main-container {
            flex-grow: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: width 0.4s ease;
        }
        #content-container {
            flex-grow: 1;
            display: grid;
            padding: 5px;
            gap: 5px;
            overflow: hidden;
        }
        #footer-controls {
            flex-shrink: 0;
            background-color: var(--bg-secondary-color);
            padding: 8px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        /* --- Immersive Mode --- */
        body.immersive-mode #left-sidebar,
        body.immersive-mode #right-sidebar,
        body.immersive-mode #footer-controls {
            position: fixed;
            opacity: 0;
            visibility: hidden;
        }
        body.immersive-mode #left-sidebar { top: 0; left: 0; transform: translateX(-100%); }
        body.immersive-mode #right-sidebar { top: 0; right: 0; transform: translateX(100%); }
        body.immersive-mode #footer-controls { bottom: 0; left: 0; right: 0; transform: translateY(100%); }
        
        body.immersive-mode #main-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
        }
        body.immersive-mode #content-container { padding: 0; gap: 1px; }

        body.immersive-mode #left-sidebar.peek,
        body.immersive-mode #right-sidebar.peek,
        body.immersive-mode #footer-controls.peek {
            opacity: 1;
            transform: translate(0, 0);
            visibility: visible;
        }

        /* --- UI Elements --- */
        h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        #easter-egg-trigger { cursor: help; user-select: none;} /* ã‚¤ãƒ¼ã‚¹ã‚¿ãƒ¼ã‚¨ãƒƒã‚°ç”¨ */
        .setting-group { margin-bottom: 20px; }
        .setting-group label { display: block; margin-bottom: 8px; font-size: 14px; user-select: none; }
        input[type="range"] { width: 100%; }
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 8px;
            background-color: var(--input-bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 4px;
        }
        button {
            padding: 8px 12px;
            background-color: var(--button-bg-color);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
            white-space: nowrap;
        }
        button:hover { background-color: var(--button-hover-bg-color); }
        button:disabled { background-color: #333; color: #888; cursor: not-allowed; }
        .button-group { display: flex; gap: 5px; }
        .button-group button { flex-grow: 1; }
        .button-group button.active { background-color: var(--primary-color); color: white; }
        .danger-button { background-color: var(--danger-color); }
        .danger-button:hover { background-color: #c0392b; }

        /* --- Content View --- */
        .content-wrapper {
            position: relative;
            background-color: var(--input-bg-color);
            border-radius: 4px;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }
        .content-loader {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }
        iframe, video, img {
            width: 100%;
            height: 100%;
            border: 2px solid transparent;
            box-sizing: border-box;
            object-fit: contain;
            transition: transform 0.3s, border 0.2s;
            background-color: #000;
        }
        iframe.fill-mode, video.fill-mode, img.fill-mode { object-fit: cover; }
        .selected { border: 2px solid var(--primary-color); box-shadow: 0 0 10px var(--primary-color); z-index: 10; }

        /* --- Spotlight (Main-focus) Mode --- */
        body.spotlight-mode #content-container {
            position: relative;
            display: block; /* Disable grid */
        }
        body.spotlight-mode .content-wrapper {
            position: absolute;
            right: 10px;
            width: 240px;      /* à¤ªà¤¹à¤²à¥‡ à¤¸à¥‡ à¤¬à¤¡à¤¼à¤¾ */
            height: 135px;     /* 16:9 Aspect Ratio */
            z-index: 5;
            cursor: pointer;
        }
        body.spotlight-mode .content-wrapper:hover {
            transform: scale(1.05);
            z-index: 6;
        }
        body.spotlight-mode .content-wrapper.spotlight {
            position: absolute;
            top: 0;
            left: 0;
            width: calc(100% - 260px); /* ã‚µãƒ ãƒã‚¤ãƒ«é ˜åŸŸã‚’ç¢ºä¿ */
            height: 100%;
            z-index: 7;
            cursor: default;
        }
        body.spotlight-mode .content-wrapper.spotlight:hover {
            transform: none; /* ä¸»è»¸ã¯æ‹¡å¤§ã—ãªã„ */
        }
        
        /* --- Left Sidebar Specifics --- */
        #url-inputs { max-height: 250px; overflow-y: auto; margin-bottom: 10px; }
        .url-input { display: flex; gap: 5px; margin-bottom: 5px; }
        #drop-zone {
            border: 2px dashed var(--border-color);
            padding: 20px;
            text-align: center;
            border-radius: 5px;
            transition: background-color 0.2s, border-color 0.2s;
        }
        #drop-zone.dragover { background-color: var(--button-bg-color); border-color: var(--primary-color); }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--bg-secondary-color);
            padding: 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h2 { margin-top: 0; }
        .modal-content code { background: var(--bg-color); padding: 2px 5px; border-radius: 3px; }
        .custom-link-manager-item { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; font-size: 14px; }
        .custom-link-manager-item span { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body class="dark-theme">

    <!-- Left Sidebar: Content Input -->
    <div id="left-sidebar">
        <h3 id="easter-egg-trigger">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¿½åŠ </h3>
        <div class="setting-group">
            <label>URLã‚’å…¥åŠ›</label>
            <div id="url-inputs">
                <div class="url-input">
                    <input type="text" placeholder="Web/å‹•ç”»/ç”»åƒã®URL">
                    <button onclick="removeUrlInput(this)">-</button>
                </div>
            </div>
            <div class="button-group">
                <button onclick="addUrlInput()">+</button>
                <button onclick="loadUrls()">èª­ã¿è¾¼ã¿</button>
            </div>
        </div>
        <div class="setting-group">
            <label>ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ </label>
            <div id="drop-zone">ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
        </div>
        <div class="setting-group">
            <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
            <div id="preset-buttons" class="button-group" style="flex-wrap: wrap;"></div>
            <div class="button-group" style="margin-top:5px;">
                <select id="preset-slot"></select>
                <button onclick="savePreset()">ä¿å­˜</button>
                <button onclick="deletePreset()" class="danger-button">å‰Šé™¤</button>
            </div>
        </div>
        <hr>
        <div class="setting-group">
             <button onclick="clearAllContents()" class="danger-button" style="width:100%;">å…¨ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="main-container">
        <div id="content-container"></div>
        <div id="footer-controls">
            <button onclick="playAllVideos()">â–¶ ä¸€æ–‰å†ç”Ÿ</button>
            <button onclick="pauseAllVideos()">âšâš ä¸€æ–‰åœæ­¢</button>
            <button onclick="toggleAllMute()">ğŸ”‡ ãƒŸãƒ¥ãƒ¼ãƒˆ/è§£é™¤</button>
            <button onclick="equalizeAllVolumes()">ğŸ”Š éŸ³é‡å‡ä¸€åŒ–</button>
            <button onclick="reloadAll()">ğŸ”„ ä¸€æ–‰ãƒªãƒ­ãƒ¼ãƒ‰</button>
            <button onclick="saveStateToUrl()">ğŸ”— å…±æœ‰URLç™ºè¡Œ</button>
            <button id="spotlight-mode-btn" onclick="toggleSpotlightMode()">ğŸ‘ï¸â€ğŸ—¨ï¸ ä¸»è»¸ãƒ¢ãƒ¼ãƒ‰</button>
            <button onclick="toggleImmersiveMode()">ğŸ‘ï¸ æ²¡å…¥ãƒ¢ãƒ¼ãƒ‰</button>
        </div>
    </div>

    <!-- Right Sidebar: Settings -->
    <div id="right-sidebar">
        <h3>å…¨ä½“è¨­å®š</h3>
        <div class="setting-group">
            <label>ãƒ†ãƒ¼ãƒ: <span id="theme-name">ãƒ€ãƒ¼ã‚¯</span></label>
            <button onclick="toggleTheme()">ãƒ†ãƒ¼ãƒåˆ‡æ›¿</button>
        </div>
        <div class="setting-group">
            <label>åˆ—æ•°: <span id="columnCountValue">2</span></label>
            <input type="range" id="columnCount" min="1" max="10" value="2" oninput="adjustColumnCount(this.value)">
        </div>
        <div class="setting-group">
            <label>ä½™ç™½: <span id="gapSliderValue">5</span>px</label>
            <input type="range" id="gapSlider" min="0" max="50" value="5" oninput="adjustGap(this.value)">
        </div>
        <div class="setting-group">
            <label>è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
            <div class="button-group">
                <button id="fit-mode-btn" class="active" onclick="setAspectRatioMode('contain')">æ¯”ç‡ç¶­æŒ</button>
                <button id="fill-mode-btn" onclick="setAspectRatioMode('cover')">å…¨ç”»é¢</button>
            </div>
        </div>
         <div class="setting-group">
            <button onclick="optimizeLayout()" style="width: 100%;">ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæœ€é©åŒ–</button>
        </div>
        <div class="setting-group">
            <label style="display:inline-flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="muteOthersOnSelect" onchange="updateSelection(selectedElement)">
                <span>é¸æŠæ™‚ã«ä»–ã‚’ãƒŸãƒ¥ãƒ¼ãƒˆ</span>
            </label>
        </div>
        <hr>
        <h3>é¸æŠä¸­ (<span id="selected-info">ãªã—</span>)</h3>
        <div id="selected-item-settings" class="setting-group" style="opacity: 0.5;">
            <input type="text" id="urlInputSettings" placeholder="URLã‚’å¤‰æ›´ã—ã¦Enter" style="margin-bottom: 10px;">
            <div class="button-group" style="margin-bottom: 5px;">
                <button onclick="reloadSelected()">ãƒªãƒ­ãƒ¼ãƒ‰</button>
                <button onclick="rotateSelected()">å›è»¢</button>
                <button onclick="flipSelected()">åè»¢</button>
            </div>
            <div class="button-group">
                <button onclick="duplicateSelected()">è¤‡è£½</button>
                <button onclick="removeSelected()" class="danger-button" style="flex-grow: 2;">å‰Šé™¤</button>
            </div>
            <!-- Video specific controls -->
            <div id="video-controls" style="margin-top: 15px;">
                 <label>éŸ³é‡: <span id="volumeValue">100</span>%</label>
                 <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1" oninput="changeSelectedVideoVolume(this.value)">
                 <label style="margin-top:10px;">å†ç”Ÿé€Ÿåº¦</label>
                 <div class="button-group" id="playback-rate-buttons">
                    <button onclick="changeSelectedVideoPlaybackRate(0.5)">0.5x</button>
                    <button onclick="changeSelectedVideoPlaybackRate(1.0)" class="active">1.0x</button>
                    <button onclick="changeSelectedVideoPlaybackRate(1.5)">1.5x</button>
                    <button onclick="changeSelectedVideoPlaybackRate(2.0)">2.0x</button>
                 </div>
            </div>
        </div>
        <hr>
        <button onclick="showModal('help-modal')">ï¼Ÿ ä½¿ã„æ–¹</button>
        <button onclick="showModal('terms-modal')" style="margin-top:5px;">åˆ©ç”¨è¦ç´„</button>
    </div>

    <!-- Modals -->
    <div id="help-modal" class="modal-overlay" onclick="closeAllModals()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>
            <p><b>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¿½åŠ :</b><br>å·¦ã®ãƒ‘ãƒãƒ«ã§URLã‚’å…¥åŠ›ã—ã€Œèª­ã¿è¾¼ã¿ã€ã‚’æŠ¼ã™ã‹ã€å‹•ç”»/ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‚¹ç·šã‚¨ãƒªã‚¢ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ã€Œè¿½åŠ ã€ã—ã¾ã™ã€‚</p>
            <p><b>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´:</b><br>å³ã®ãƒ‘ãƒãƒ«ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ã€å…¨ä½“ã®åˆ—æ•°ã‚„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é–“ã®ä½™ç™½ã‚’èª¿æ•´ã§ãã¾ã™ã€‚ã€Œãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæœ€é©åŒ–ã€ãƒœã‚¿ãƒ³ã‚‚ä¾¿åˆ©ã§ã™ã€‚</p>
            <p><b>å€‹åˆ¥æ“ä½œ:</b><br>ä¸­å¤®ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠï¼ˆé’æ ãŒä»˜ãã¾ã™ï¼‰ã€‚é¸æŠå¾Œã€å³ãƒ‘ãƒãƒ«ã§URLå¤‰æ›´ã€å›è»¢ã€åè»¢ã€è¤‡è£½ã€å‰Šé™¤ãŒã§ãã¾ã™ã€‚å‹•ç”»ã®å ´åˆã¯éŸ³é‡ã‚„å†ç”Ÿé€Ÿåº¦ã‚‚èª¿æ•´å¯èƒ½ã§ã™ã€‚</p>
            <p><b>éŸ³é‡å‡ä¸€åŒ–:</b><br>ä¸‹ã®ã€ŒğŸ”Šã€ãƒœã‚¿ãƒ³ã§ã€å†ç”Ÿä¸­ã®å‹•ç”»å…¨ã¦ã®éŸ³é‡ã‚’å‡ç­‰ã«å‰²ã‚ŠæŒ¯ã‚Šã¾ã™ã€‚ç‰¹å®šã®å‹•ç”»ã ã‘éŸ³ãŒå¤§ãã„å ´åˆã«ä¾¿åˆ©ã§ã™ã€‚</p>
            <p><b>ä¸»è»¸ãƒ¢ãƒ¼ãƒ‰:</b><br>ä¸‹ã®ã€ŒğŸ‘ï¸â€ğŸ—¨ï¸ã€ãƒœã‚¿ãƒ³ã§ã€é¸æŠä¸­ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¸»å½¹ã«ã—ã¾ã™ã€‚ä»–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯å³å´ã«ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã•ã‚Œã€ã‚¯ãƒªãƒƒã‚¯ã§ä¸»å½¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å…ƒã®ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºã«æˆ»ã‚Šã¾ã™ã€‚</p>
            <p><b>æ²¡å…¥ãƒ¢ãƒ¼ãƒ‰:</b><br>ä¸‹ã®ã€ŒğŸ‘ï¸ã€ãƒœã‚¿ãƒ³ã§UIã‚’éš ã—ã¾ã™ã€‚ãƒã‚¦ã‚¹ã‚’ç”»é¢å·¦å³ä¸‹ç«¯ã«å¯„ã›ã‚‹ã¨UIãŒä¸€æ™‚çš„ã«ç¾ã‚Œã€UIã‹ã‚‰ã‚«ãƒ¼ã‚½ãƒ«ãŒé›¢ã‚Œã‚‹ã¨è‡ªå‹•ã§éš ã‚Œã¾ã™ã€‚</p>
            <p><b>å…±æœ‰æ©Ÿèƒ½:</b><br>ä¸‹ã®ã€Œå…±æœ‰URLç™ºè¡Œã€ãƒœã‚¿ãƒ³ã§ã€ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜ã—ãŸURLãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚<br><b style="color:var(--danger-color)">æ³¨æ„:</b> PCå†…ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§è¿½åŠ ã—ãŸã‚‚ã®ï¼‰ã¯ã€URLã«å«ã¾ã‚Œãšå…±æœ‰ã§ãã¾ã›ã‚“ã€‚</p>
            <p><b>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä¸€è¦§ (<code>?</code>ã‚­ãƒ¼ã§ã‚‚è¡¨ç¤º):</b></p>
            <ul>
                <li><code>â†</code> <code>â†’</code> <code>â†‘</code> <code>â†“</code>: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é¸æŠ</li>
                <li><code>1</code>-<code>9</code>: 1-9ç•ªç›®ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç›´æ¥é¸æŠ</li>
                <li><code>Delete</code> / <code>Backspace</code>: é¸æŠä¸­ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å‰Šé™¤</li>
                <li><code>R</code>: é¸æŠä¸­ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒªãƒ­ãƒ¼ãƒ‰</li>
                <li><code>D</code>: é¸æŠä¸­ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¤‡è£½ã—ã¦æœ«å°¾ã«è¿½åŠ </li>
                <li><code>Enter</code>: é¸æŠä¸­ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è¡¨ç¤º</li>
                <li><code>Space</code>: é¸æŠä¸­ã®å‹•ç”»ã‚’å†ç”Ÿ/åœæ­¢</li>
                <li><code>M</code>: é¸æŠä¸­ã®å‹•ç”»ã‚’ãƒŸãƒ¥ãƒ¼ãƒˆ/è§£é™¤</li>
                <li><code>F</code>: æ²¡å…¥ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ</li>
                <li><code>+</code> / <code>-</code>: åˆ—æ•°ã‚’å¢—æ¸›</li>
                <li><code>Alt + P</code>: å…¨å‹•ç”»ã‚’å†ç”Ÿ, <code>Alt + S</code>: å…¨å‹•ç”»ã‚’åœæ­¢</li>
            </ul>
            <div id="custom-links-container-help"></div>
            <button onclick="closeAllModals()" style="margin-top: 15px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    <div id="terms-modal" class="modal-overlay" onclick="closeAllModals()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>åˆ©ç”¨è¦ç´„ãƒ»å…è²¬äº‹é …</h2>
            <p>æœ¬ãƒ„ãƒ¼ãƒ«ã¯ã€ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‚„ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã¯ä¸€åˆ‡è¡Œã„ã¾ã›ã‚“ã€‚</p>
            <ol>
                <li><b>ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è‘—ä½œæ¨©:</b> æœ¬ãƒ„ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è‘—ä½œæ¨©ã¯ã€å„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ¶ä½œè€…ã¾ãŸã¯æ¨©åˆ©è€…ã«å¸°å±ã—ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€å„å›½ã®è‘—ä½œæ¨©æ³•ã‚’éµå®ˆã™ã‚‹è²¬ä»»ã‚’è² ã„ã¾ã™ã€‚</li>
                <li><b>è¡¨ç¤ºã®åˆ¶ç´„:</b> ä¸€éƒ¨ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã¯ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ï¼ˆX-Frame-Optionsãªã©ï¼‰ã«ã‚ˆã‚Šã€æœ¬ãƒ„ãƒ¼ãƒ«å†…ã«è¡¨ç¤ºã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã¯ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆå´ã®ä»•æ§˜ã§ã‚ã‚Šã€æœ¬ãƒ„ãƒ¼ãƒ«ã®ä¸å…·åˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
                <li><b>å…è²¬äº‹é …:</b> æœ¬ãƒ„ãƒ¼ãƒ«ã®åˆ©ç”¨ã«ã‚ˆã£ã¦ç”Ÿã˜ãŸã„ã‹ãªã‚‹æå®³ã«ã¤ã„ã¦ã‚‚ã€é–‹ç™ºè€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚è‡ªå·±è²¬ä»»ã§ã”åˆ©ç”¨ãã ã•ã„ã€‚</li>
            </ol>
            <div id="custom-links-container-terms"></div>
            <button onclick="closeAllModals()" style="margin-top: 15px;">åŒæ„ã—ã¦é–‰ã˜ã‚‹</button>
        </div>
    </div>
    
    <!-- Easter Egg Modal -->
    <div id="easter-egg-modal" class="modal-overlay" onclick="closeAllModals()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>ç§˜å¯†ã®è¨­å®šãƒ‘ãƒãƒ«</h2>
            <p>ã‚ˆãè¦‹ã¤ã‘ã¾ã—ãŸã­ï¼ã“ã“ã§ã¯ç‰¹åˆ¥ãªè¨­å®šãŒã§ãã¾ã™ã€‚</p>
            <hr>
            <div class="setting-group">
                <label>ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¹ãƒ­ãƒƒãƒˆæ•°: <span id="preset-slot-count-value">5</span></label>
                <input type="range" id="preset-slot-count" min="5" max="20" value="5" oninput="updatePresetSlotCount(this.value)">
            </div>
            <div class="setting-group">
                <label>èƒŒæ™¯ç”»åƒURL</label>
                <input type="text" id="background-image-url" placeholder="ç”»åƒã®URLã‚’å…¥åŠ›ã¾ãŸã¯ãƒšãƒ¼ã‚¹ãƒˆ">
                <div class="button-group" style="margin-top:5px;">
                    <button onclick="setBackgroundImage()">é©ç”¨</button>
                    <button onclick="clearBackgroundImage()" class="danger-button">ã‚¯ãƒªã‚¢</button>
                </div>
            </div>
            <div class="setting-group">
                <label>éš ã—ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
                <div id="secret-preset-buttons" class="button-group"></div>
                <div class="button-group" style="margin-top:5px;">
                    <select id="secret-preset-slot">
                        <option value="1">Secret 1</option><option value="2">Secret 2</option><option value="3">Secret 3</option>
                    </select>
                    <button onclick="saveSecretPreset()">ä¿å­˜</button>
                    <button onclick="deleteSecretPreset()" class="danger-button">å‰Šé™¤</button>
                </div>
            </div>
            <div class="setting-group">
                <label>ã‚«ã‚¹ã‚¿ãƒ URLã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç®¡ç†</label>
                <div id="custom-links-manager" style="max-height: 150px; overflow-y: auto; margin-bottom: 10px; border: 1px solid var(--border-color); padding: 5px; border-radius: 4px;"></div>
                <div class="button-group" style="margin-top:5px;">
                    <input type="text" id="new-link-name" placeholder="ãƒªãƒ³ã‚¯å" style="width: 40%;">
                    <input type="text" id="new-link-url" placeholder="https://example.com" style="flex-grow: 1;">
                    <button onclick="addCustomLink()">è¿½åŠ </button>
                </div>
            </div>
            <hr>
            <button onclick="closeAllModals()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // --- App State ---
        let selectedElement = null;
        let isSpotlightMode = false;
        let presetSlotCount = 5;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadEasterEggSettings();
            if (!localStorage.getItem('visited')) {
                showModal('help-modal');
                localStorage.setItem('visited', 'true');
            }
            setupDragAndDrop();
            setupKeyboardShortcuts();
            setupImmersiveModePeek();
            setupEasterEggTrigger();
            renderPresetButtons();
            loadStateFromUrl();
            updateSelection(null); // Initialize panel state
        });

        // --- Core UI Functions ---
        function addUrlInput() {
            const container = document.getElementById('url-inputs');
            const div = document.createElement('div');
            div.className = 'url-input';
            div.innerHTML = `<input type="text" placeholder="Web/å‹•ç”»/ç”»åƒã®URL"><button onclick="removeUrlInput(this)">-</button>`;
            container.appendChild(div);
        }
        function removeUrlInput(button) {
            const container = document.getElementById('url-inputs');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }
        function loadUrls() {
            const urls = Array.from(document.querySelectorAll('#url-inputs input'))
                .map(input => input.value.trim())
                .filter(url => url !== '');
            if (urls.length > 0) createContentView(urls, true); // Replace all
        }
        function clearAllContents() {
            if (confirm('ã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                document.getElementById('content-container').innerHTML = '';
                if(isSpotlightMode) toggleSpotlightMode(); // Exit spotlight mode if active
                updateSelection(null);
            }
        }

        // --- Content Creation and Management ---
        function createContentView(urls, replace = true) {
            if (isSpotlightMode) toggleSpotlightMode(); // Always exit spotlight mode on content change
            const container = document.getElementById('content-container');
            if (replace) {
                container.innerHTML = '';
            }
            const startIndex = container.children.length;

            urls.forEach((url, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'content-wrapper';
                wrapper.dataset.index = startIndex + index + 1;
                
                const loader = document.createElement('div');
                loader.className = 'content-loader';
                wrapper.appendChild(loader);

                let element;
                if (url.match(/\.(jpeg|jpg|gif|png|webp|svg)$/i)) {
                    element = document.createElement('img');
                } else if (url.match(/\.(mp4|webm|ogg|mov)$/i) || url.startsWith('blob:')) {
                    element = document.createElement('video');
                    element.controls = true;
                    element.muted = true;
                    element.autoplay = true;
                    element.loop = true;
                    element.addEventListener('volumechange', () => updateSelectedVideoUI(element));
                    element.addEventListener('ratechange', () => updateSelectedVideoUI(element));
                } else {
                    element = document.createElement('iframe');
                    element.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms allow-popups allow-presentation');
                    element.setAttribute('allow', 'autoplay; encrypted-media; fullscreen');
                }
                
                element.src = url;
                element.style.opacity = '0';
                element.onload = element.oncanplay = () => {
                    loader.remove();
                    element.style.opacity = '1';
                };
                element.onerror = () => {
                    loader.remove();
                    wrapper.innerHTML += '<p style="text-align:center; padding:10px; color: var(--danger-color);">èª­è¾¼å¤±æ•—</p>';
                };

                element.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    e.stopPropagation(); 
                    selectElement(wrapper); 
                });
                element.addEventListener('dblclick', () => {
                    try {
                        if (element.requestFullscreen) element.requestFullscreen();
                    } catch (e) {
                        console.error("Fullscreen failed:", e);
                    }
                });

                wrapper.appendChild(element);
                container.appendChild(wrapper);
            });
            adjustColumnCount(document.getElementById('columnCount').value);
            setAspectRatioMode(document.querySelector('#right-sidebar .button-group button.active')?.id === 'fill-mode-btn' ? 'cover' : 'contain', false);
            if(replace) updateSelection(null);
        }
        
        function selectElement(wrapper) {
            if (selectedElement === wrapper && !isSpotlightMode) {
                updateSelection(null);
                return;
            }
            if(isSpotlightMode) {
                const currentSpot = document.querySelector('.content-wrapper.spotlight');
                if(currentSpot) currentSpot.classList.remove('spotlight');
                wrapper.classList.add('spotlight');
                updateSpotlightLayout(); // BUG FIX: Re-calculate layout after changing spotlight
            }
            updateSelection(wrapper);
        }

        function updateSelection(wrapper) {
            if (selectedElement) selectedElement.classList.remove('selected');
            selectedElement = wrapper;
            const settingsPanel = document.getElementById('selected-item-settings');
            const videoControls = document.getElementById('video-controls');
            
            if (document.getElementById('muteOthersOnSelect').checked) {
                document.querySelectorAll('video').forEach(v => v.muted = true);
            }

            if (selectedElement) {
                selectedElement.classList.add('selected');
                settingsPanel.style.opacity = '1';
                settingsPanel.querySelectorAll('button, input').forEach(el => el.disabled = false);
                const content = selectedElement.querySelector('iframe, video, img');
                document.getElementById('urlInputSettings').value = content.src;
                document.getElementById('selected-info').textContent = `#${selectedElement.dataset.index}`;
                
                const video = selectedElement.querySelector('video');
                if (video) {
                    videoControls.style.display = 'block';
                    if (document.getElementById('muteOthersOnSelect').checked) video.muted = false;
                    updateSelectedVideoUI(video);
                } else {
                    videoControls.style.display = 'none';
                }

            } else {
                settingsPanel.style.opacity = '0.5';
                settingsPanel.querySelectorAll('button, input').forEach(el => el.disabled = true);
                videoControls.style.display = 'none';
                document.getElementById('urlInputSettings').value = '';
                document.getElementById('selected-info').textContent = `ãªã—`;
            }
        }
        
        function updateSelectedVideoUI(videoElement) {
            if (!selectedElement || selectedElement.querySelector('video') !== videoElement) return;

            const volume = videoElement.muted ? 0 : videoElement.volume;
            document.getElementById('volumeSlider').value = volume;
            document.getElementById('volumeValue').textContent = Math.round(volume * 100);

            const rate = videoElement.playbackRate;
            document.querySelectorAll('#playback-rate-buttons button').forEach(btn => {
                btn.classList.toggle('active', parseFloat(btn.textContent) === rate);
            });
        }

        // --- Selected Item Controls ---
        document.getElementById('urlInputSettings').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                if (!selectedElement) return;
                const url = e.target.value.trim();
                if (url) {
                    const urls = Array.from(document.querySelectorAll('#content-container > .content-wrapper > *')).map(el => el.src);
                    const selectedIndex = Array.from(document.querySelectorAll('.content-wrapper')).indexOf(selectedElement);
                    urls[selectedIndex] = url;
                    createContentView(urls, true);
                }
            }
        });
        function reloadSelected() { if(selectedElement) { const c = selectedElement.querySelector('iframe, video, img'); if(c) { c.src = c.src; } } }
        function removeSelected() {
            if(selectedElement) {
                 const parent = selectedElement.parentElement;
                 const wasSpotlight = selectedElement.classList.contains('spotlight');
                 selectedElement.remove();
                 
                 let newSelection = null;
                 if (isSpotlightMode && wasSpotlight && parent.children.length > 0) {
                     newSelection = parent.firstElementChild;
                     newSelection.classList.add('spotlight');
                 }
                 updateSelection(newSelection);
                 
                 Array.from(parent.children).forEach((child, index) => { child.dataset.index = index + 1; });
                 if(parent.children.length === 0 && isSpotlightMode) toggleSpotlightMode();
                 else if (isSpotlightMode) updateSpotlightLayout();
            }
        }
        function applyTransform(contentElement) {
            const rotation = parseInt(contentElement.dataset.rotation || 0);
            const isFlipped = contentElement.classList.contains('flipped');
            let transformString = `rotate(${rotation}deg)`;
            if (isFlipped) transformString += ' scaleX(-1)';
            contentElement.style.transform = transformString;
        }
        function rotateSelected() {
            if (!selectedElement) return;
            const content = selectedElement.querySelector('iframe, video, img');
            const currentRotation = parseInt(content.dataset.rotation || 0);
            content.dataset.rotation = (currentRotation + 90) % 360;
            applyTransform(content);
        }
        function flipSelected() {
            if (!selectedElement) return;
            const content = selectedElement.querySelector('iframe, video, img');
            content.classList.toggle('flipped');
            applyTransform(content);
        }
        function duplicateSelected() {
            if (!selectedElement) return;
            const src = selectedElement.querySelector('iframe, video, img').src;
            createContentView([src], false);
        }
        function changeSelectedVideoVolume(value) {
            if (!selectedElement) return;
            const video = selectedElement.querySelector('video');
            if (video) {
                video.muted = (value == 0);
                video.volume = value;
                updateSelectedVideoUI(video);
            }
        }
        function changeSelectedVideoPlaybackRate(rate) {
            if (!selectedElement) return;
            const video = selectedElement.querySelector('video');
            if (video) {
                video.playbackRate = rate;
                updateSelectedVideoUI(video); // BUG FIX: UIã‚’ç›´æ¥æ›´æ–°
            }
        }

        // --- Global Controls ---
        function adjustColumnCount(value) {
            if (isSpotlightMode) return;
            document.getElementById('content-container').style.gridTemplateColumns = `repeat(${value}, 1fr)`;
            document.getElementById('columnCountValue').textContent = value;
        }
        function adjustGap(value) {
            if (isSpotlightMode) return;
            document.getElementById('content-container').style.gap = `${value}px`;
            document.getElementById('gapSliderValue').textContent = value;
        }
        function setAspectRatioMode(mode, updateButtons = true) {
            document.querySelectorAll('iframe, video, img').forEach(el => el.style.objectFit = mode);
            if(updateButtons) {
                document.getElementById('fit-mode-btn').classList.toggle('active', mode === 'contain');
                document.getElementById('fill-mode-btn').classList.toggle('active', mode === 'cover');
            }
        }
        function optimizeLayout() {
            if (isSpotlightMode) return;
            const count = document.getElementById('content-container').children.length;
            if (count > 0) {
                const cols = Math.ceil(Math.sqrt(count));
                document.getElementById('columnCount').value = cols;
                adjustColumnCount(cols);
            }
        }
        function playAllVideos() { document.querySelectorAll('video').forEach(v => v.play().catch(e => console.log("Autoplay may be blocked by the browser."))); }
        function pauseAllVideos() { document.querySelectorAll('video').forEach(v => v.pause()); }
        function toggleAllMute() {
            const videos = document.querySelectorAll('video');
            if (videos.length === 0) return;
            const isAnyMuted = Array.from(videos).some(v => v.muted);
            videos.forEach(v => v.muted = !isAnyMuted);
        }
        function reloadAll() { document.querySelectorAll('iframe, video, img').forEach(el => { el.src = el.src; }); }
        
        function equalizeAllVolumes() {
            const audibleVideos = Array.from(document.querySelectorAll('video')).filter(v => !v.muted && v.volume > 0);
            if (audibleVideos.length < 2) {
                alert('å‡ä¸€åŒ–ã®å¯¾è±¡ã¨ãªã‚‹éŸ³å£°ä»˜ãå‹•ç”»ãŒ2ã¤ä»¥ä¸Šã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            const targetVolume = 1.0 / audibleVideos.length;
            audibleVideos.forEach(v => {
                v.volume = targetVolume;
            });
            if (selectedElement && audibleVideos.includes(selectedElement.querySelector('video'))) {
                updateSelectedVideoUI(selectedElement.querySelector('video'));
            }
            alert(`${audibleVideos.length}å€‹ã®å‹•ç”»ã®éŸ³é‡ã‚’ãã‚Œãã‚Œ${Math.round(targetVolume * 100)}%ã«èª¿æ•´ã—ã¾ã—ãŸã€‚`);
        }
        
        // --- Spotlight Mode ---
        function toggleSpotlightMode() {
            const container = document.getElementById('content-container');
            if (container.children.length === 0) return;
            if (!selectedElement && !isSpotlightMode) {
                selectElement(container.firstElementChild);
            }
            isSpotlightMode = !isSpotlightMode;
            document.body.classList.toggle('spotlight-mode', isSpotlightMode);
            document.getElementById('spotlight-mode-btn').classList.toggle('active', isSpotlightMode);
            
            const controls = ['columnCount', 'gapSlider', 'fit-mode-btn', 'fill-mode-btn'];
            controls.forEach(id => document.getElementById(id).disabled = isSpotlightMode);
            
            updateSpotlightLayout();
        }

        function updateSpotlightLayout() {
            const container = document.getElementById('content-container');
            const wrappers = Array.from(container.children);
            
            if (isSpotlightMode) {
                let currentSpot = container.querySelector('.spotlight');
                if (!currentSpot) {
                    currentSpot = selectedElement || container.firstElementChild;
                    currentSpot.classList.add('spotlight');
                }
                if (selectedElement !== currentSpot) updateSelection(currentSpot);

                let thumbTop = 10;
                wrappers.forEach(w => {
                    if (w !== currentSpot) {
                        w.style.top = `${thumbTop}px`;
                        thumbTop += 135 + 10; // thumbnail height + gap
                    }
                });
            } else {
                wrappers.forEach(w => {
                    w.classList.remove('spotlight');
                    w.style.top = '';
                    w.style.right = '';
                });
                adjustColumnCount(document.getElementById('columnCount').value);
                adjustGap(document.getElementById('gapSlider').value);
            }
        }

        // --- Drag & Drop ---
        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');
            const body = document.body;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                body.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
            ['dragenter', 'dragover'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover')));
            ['dragleave', 'drop'].forEach(eventName => dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover')));
            
            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const urls = Array.from(files).map(file => URL.createObjectURL(file));
                    createContentView(urls, false);
                }
            });
        }
        
        // --- State Management (URL & Presets) ---
        function saveStateToUrl() {
            const urls = Array.from(document.querySelectorAll('#content-container > .content-wrapper > *'))
                .map(el => el.src)
                .filter(src => !src.startsWith('blob:'));
            if(urls.length !== document.querySelectorAll('#content-container > .content-wrapper').length) {
                alert('è­¦å‘Š: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯å…±æœ‰URLã«å«ã¾ã‚Œã¾ã›ã‚“ã€‚Webä¸Šã®URLã®ã¿ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚');
            }
            if (urls.length === 0) { alert('å…±æœ‰ã§ãã‚‹URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }

            const params = new URLSearchParams();
            urls.forEach(url => params.append('url', encodeURIComponent(url)));
            params.set('cols', document.getElementById('columnCount').value);
            params.set('gap', document.getElementById('gapSlider').value);
            
            const newUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?${params.toString()}`;
            window.history.pushState({ path: newUrl }, '', newUrl);
            navigator.clipboard.writeText(newUrl).then(() => alert('å…±æœ‰URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚'));
        }
        function loadStateFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const urls = params.getAll('url').map(url => decodeURIComponent(url));
            if (urls.length > 0) {
                createContentView(urls, true);
                const cols = params.get('cols') || Math.ceil(Math.sqrt(urls.length));
                const gap = params.get('gap') || 5;
                document.getElementById('columnCount').value = cols;
                adjustColumnCount(cols);
                document.getElementById('gapSlider').value = gap;
                adjustGap(gap);
            }
        }
        function savePreset() {
            const slot = document.getElementById('preset-slot').value;
            const urls = Array.from(document.querySelectorAll('#content-container > .content-wrapper > *'))
                .map(el => el.src)
                .filter(src => !src.startsWith('blob:'));
            if (urls.length > 0) {
                localStorage.setItem(`preset_${slot}`, JSON.stringify(urls));
                alert(`ç¾åœ¨ã®URLã®çµ„ã¿åˆã‚ã›ã‚’ãƒ—ãƒªã‚»ãƒƒãƒˆ${slot}ã«ä¿å­˜ã—ã¾ã—ãŸã€‚`);
                renderPresetButtons();
            } else {
                alert('ä¿å­˜ã™ã‚‹URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚(ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿å­˜ã§ãã¾ã›ã‚“)');
            }
        }
        function loadPreset(slot) {
            const urlsJson = localStorage.getItem(`preset_${slot}`);
            if (urlsJson) {
                createContentView(JSON.parse(urlsJson), true);
            } else {
                alert(`ãƒ—ãƒªã‚»ãƒƒãƒˆ${slot}ã¯ç©ºã§ã™ã€‚`);
            }
        }
        function deletePreset() {
            const slot = document.getElementById('preset-slot').value;
            if (localStorage.getItem(`preset_${slot}`)) {
                if (confirm(`ãƒ—ãƒªã‚»ãƒƒãƒˆ${slot}ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                    localStorage.removeItem(`preset_${slot}`);
                    alert(`ãƒ—ãƒªã‚»ãƒƒãƒˆ${slot}ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                    renderPresetButtons();
                }
            } else {
                alert(`ãƒ—ãƒªã‚»ãƒƒãƒˆ${slot}ã¯ç©ºã§ã™ã€‚`);
            }
        }
        function renderPresetButtons() {
            const container = document.getElementById('preset-buttons');
            container.innerHTML = '';
            for (let i = 1; i <= presetSlotCount; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                if (localStorage.getItem(`preset_${i}`)) {
                    button.title = `ãƒ—ãƒªã‚»ãƒƒãƒˆ${i}ã‚’èª­ã¿è¾¼ã‚€`;
                    button.onclick = () => loadPreset(i);
                } else {
                    button.disabled = true;
                    button.title = `ãƒ—ãƒªã‚»ãƒƒãƒˆ${i}ã¯ç©ºã§ã™`;
                }
                container.appendChild(button);
            }
        }

        // --- Keyboard Shortcuts ---
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (document.querySelector('.modal-overlay.visible')) return;
                if (e.target.tagName === 'INPUT' && e.target.type !== 'range') return;

                if (e.key === '?') { showModal('help-modal'); return; }
                
                if (e.key.startsWith('Arrow')) {
                    e.preventDefault();
                    navigateGrid(e.key);
                } else if (e.key >= '1' && e.key <= '9') {
                    const el = document.querySelector(`.content-wrapper[data-index='${e.key}']`);
                    if (el) selectElement(el);
                } else if (e.key === 'Delete' || e.key === 'Backspace') {
                    removeSelected();
                } else if (e.key.toLowerCase() === 'r') {
                    reloadSelected();
                } else if (e.key.toLowerCase() === 'd') {
                    duplicateSelected();
                } else if (e.key.toLowerCase() === 'f') {
                    toggleImmersiveMode();
                } else if (e.key === 'Enter') {
                    if (selectedElement) selectedElement.querySelector('iframe,video,img')?.requestFullscreen();
                } else if (e.key === '=' || e.key === '+') {
                     const slider = document.getElementById('columnCount');
                     slider.value = Math.min(parseInt(slider.value) + 1, slider.max);
                     adjustColumnCount(slider.value);
                } else if (e.key === '-') {
                     const slider = document.getElementById('columnCount');
                     slider.value = Math.max(parseInt(slider.value) - 1, slider.min);
                     adjustColumnCount(slider.value);
                } else if (selectedElement && selectedElement.querySelector('video')) {
                    const video = selectedElement.querySelector('video');
                    if (e.code === 'Space') { e.preventDefault(); video.paused ? video.play() : video.pause(); }
                    if (e.key.toLowerCase() === 'm') { video.muted = !video.muted; }
                } else if (e.altKey && e.key.toLowerCase() === 'p') {
                    playAllVideos();
                } else if (e.altKey && e.key.toLowerCase() === 's') {
                    pauseAllVideos();
                }
            });
        }
        function navigateGrid(key) {
            if (isSpotlightMode) return;
            if (!selectedElement) {
                const first = document.querySelector('.content-wrapper');
                if (first) selectElement(first);
                return;
            }
            const items = Array.from(document.querySelectorAll('.content-wrapper'));
            const currentIndex = items.indexOf(selectedElement);
            const cols = parseInt(document.getElementById('columnCount').value);
            let nextIndex = -1;

            switch (key) {
                case 'ArrowLeft':  nextIndex = currentIndex % cols === 0 ? currentIndex : currentIndex - 1; break;
                case 'ArrowRight': nextIndex = (currentIndex + 1) % cols === 0 || (currentIndex + 1 >= items.length) ? currentIndex : currentIndex + 1; break;
                case 'ArrowUp':    nextIndex = currentIndex - cols; break;
                case 'ArrowDown':  nextIndex = currentIndex + cols; break;
            }

            if (nextIndex >= 0 && nextIndex < items.length) {
                selectElement(items[nextIndex]);
            }
        }
        
        // --- Theme, Modals & Immersive Mode ---
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            document.body.classList.toggle('dark-theme');
            document.getElementById('theme-name').textContent = document.body.classList.contains('dark-theme') ? 'ãƒ€ãƒ¼ã‚¯' : 'ãƒ©ã‚¤ãƒˆ';
        }
        function showModal(id) {
            if (id === 'help-modal') renderCustomLinks('custom-links-container-help');
            if (id === 'terms-modal') renderCustomLinks('custom-links-container-terms');
            if (id === 'easter-egg-modal') {
                document.getElementById('background-image-url').value = localStorage.getItem('bgImageUrl') || '';
                renderSecretPresetButtons();
                renderCustomLinksManager();
            }
            document.getElementById(id).classList.add('visible');
        }
        function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('visible')); }

        function toggleImmersiveMode() {
            document.body.classList.toggle('immersive-mode');
        }

        function setupImmersiveModePeek() {
            const leftSidebar = document.getElementById('left-sidebar');
            const rightSidebar = document.getElementById('right-sidebar');
            const footer = document.getElementById('footer-controls');
            const peekThreshold = 10;
            const topMargin = 30;

            document.addEventListener('mousemove', e => {
                if (!document.body.classList.contains('immersive-mode')) return;
                
                const isCursorAtTop = e.clientY < topMargin;

                if (e.clientX < peekThreshold && !isCursorAtTop) leftSidebar.classList.add('peek');
                if (e.clientX > window.innerWidth - peekThreshold && !isCursorAtTop) rightSidebar.classList.add('peek');
                if (e.clientY > window.innerHeight - peekThreshold) footer.classList.add('peek');
            });
            
            leftSidebar.addEventListener('mouseleave', () => leftSidebar.classList.remove('peek'));
            rightSidebar.addEventListener('mouseleave', () => rightSidebar.classList.remove('peek'));
            footer.addEventListener('mouseleave', () => footer.classList.remove('peek'));
        }

        // --- Easter Egg Features ---
        function setupEasterEggTrigger() {
            document.getElementById('easter-egg-trigger').addEventListener('click', () => {
                showModal('easter-egg-modal');
            });
        }

        function loadEasterEggSettings() {
            // Preset Slot Count
            presetSlotCount = parseInt(localStorage.getItem('presetSlotCount') || '5');
            document.getElementById('preset-slot-count').value = presetSlotCount;
            document.getElementById('preset-slot-count-value').textContent = presetSlotCount;
            updatePresetSelects();
            
            // Background Image
            const bgImageUrl = localStorage.getItem('bgImageUrl');
            if (bgImageUrl) {
                document.body.style.backgroundImage = `url('${bgImageUrl}')`;
            }
        }

        function updatePresetSlotCount(value) {
            presetSlotCount = parseInt(value);
            document.getElementById('preset-slot-count-value').textContent = presetSlotCount;
            localStorage.setItem('presetSlotCount', presetSlotCount);
            updatePresetSelects();
            renderPresetButtons();
        }
        
        function updatePresetSelects() {
            const select = document.getElementById('preset-slot');
            select.innerHTML = '';
            for (let i = 1; i <= presetSlotCount; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `ã‚¹ãƒ­ãƒƒãƒˆ${i}`;
                select.appendChild(option);
            }
        }
        
        function setBackgroundImage() {
            const url = document.getElementById('background-image-url').value.trim();
            if (url) {
                document.body.style.backgroundImage = `url('${url}')`;
                localStorage.setItem('bgImageUrl', url);
            }
        }
        
        function clearBackgroundImage() {
            document.body.style.backgroundImage = '';
            localStorage.removeItem('bgImageUrl');
            document.getElementById('background-image-url').value = '';
        }

        function saveSecretPreset() {
            const slot = document.getElementById('secret-preset-slot').value;
            const urls = Array.from(document.querySelectorAll('#content-container > .content-wrapper > *'))
                .map(el => el.src).filter(src => !src.startsWith('blob:'));
            if (urls.length > 0) {
                localStorage.setItem(`secret_preset_${slot}`, JSON.stringify(urls));
                alert(`ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’éš ã—ãƒ—ãƒªã‚»ãƒƒãƒˆ${slot}ã«ä¿å­˜ã—ã¾ã—ãŸã€‚`);
                renderSecretPresetButtons();
            } else {
                alert('ä¿å­˜ã™ã‚‹URLãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            }
        }

        function loadSecretPreset(slot) {
            const urlsJson = localStorage.getItem(`secret_preset_${slot}`);
            if (urlsJson) createContentView(JSON.parse(urlsJson), true);
        }

        function deleteSecretPreset() {
            const slot = document.getElementById('secret-preset-slot').value;
            if (confirm(`éš ã—ãƒ—ãƒªã‚»ãƒƒãƒˆ${slot}ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                localStorage.removeItem(`secret_preset_${slot}`);
                alert(`éš ã—ãƒ—ãƒªã‚»ãƒƒãƒˆ${slot}ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                renderSecretPresetButtons();
            }
        }

        function renderSecretPresetButtons() {
            const container = document.getElementById('secret-preset-buttons');
            container.innerHTML = '';
            for (let i = 1; i <= 3; i++) {
                const button = document.createElement('button');
                button.textContent = `S${i}`;
                if (localStorage.getItem(`secret_preset_${i}`)) {
                    button.onclick = () => loadSecretPreset(i);
                } else {
                    button.disabled = true;
                }
                container.appendChild(button);
            }
        }
        
        function getCustomLinks() {
            return JSON.parse(localStorage.getItem('custom_links') || '[]');
        }

        function saveCustomLinks(links) {
            localStorage.setItem('custom_links', JSON.stringify(links));
        }

        function addCustomLink() {
            const nameInput = document.getElementById('new-link-name');
            const urlInput = document.getElementById('new-link-url');
            const name = nameInput.value.trim();
            let url = urlInput.value.trim();

            if (name && url) {
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                const links = getCustomLinks();
                links.push({ name, url });
                saveCustomLinks(links);
                nameInput.value = '';
                urlInput.value = '';
                renderCustomLinksManager();
            } else {
                alert('ãƒªãƒ³ã‚¯åã¨URLã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        function removeCustomLink(index) {
            if (confirm('ã“ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const links = getCustomLinks();
                links.splice(index, 1);
                saveCustomLinks(links);
                renderCustomLinksManager();
            }
        }

        function renderCustomLinksManager() {
            const container = document.getElementById('custom-links-manager');
            const links = getCustomLinks();
            container.innerHTML = '';
            if (links.length === 0) {
                container.textContent = 'ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ³ã‚¯ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                return;
            }
            links.forEach((link, index) => {
                const item = document.createElement('div');
                item.className = 'custom-link-manager-item';
                item.innerHTML = `
                    <span><b>${link.name}</b>: ${link.url}</span>
                    <button class="danger-button" onclick="removeCustomLink(${index})">å‰Šé™¤</button>
                `;
                container.appendChild(item);
            });
        }
        
        function renderCustomLinks(containerId) {
            const links = getCustomLinks();
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous links
            if (links.length > 0) {
                const group = document.createElement('div');
                group.className = 'button-group';
                group.style.marginTop = '15px';
                group.style.flexWrap = 'wrap';
                group.style.justifyContent = 'flex-start';
                
                const label = document.createElement('label');
                label.textContent = 'URLã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ:';
                label.style.width = '100%';
                label.style.marginBottom = '8px';
                container.appendChild(label);
                
                links.forEach(link => {
                    const button = document.createElement('button');
                    button.textContent = link.name;
                    button.title = link.url;
                    button.style.flexGrow = '0'; // Don't stretch buttons
                    button.onclick = () => window.open(link.url, '_blank', 'noopener,noreferrer');
                    group.appendChild(button);
                });
                container.appendChild(group);
            }
        }

    </script>
</body>
</html>
